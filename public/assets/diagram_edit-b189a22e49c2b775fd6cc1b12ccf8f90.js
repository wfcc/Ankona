//--------------------------------------
// Expects input fields with IDs "diagram_white" and "diagram_black" with English notation
// Depends upon jQuery
//
// Iļja Ketris (c) 2008-2011
//
google.setOnLoadCallback(function(){function a(){for(var a=0;a<8;++a)ik.board[a]=ik.arrayOfOnes.slice(0)}function b(){ik.solving_view=!1,ik.board=[],ik.arrayOfOnes=["1","1","1","1","1","1","1","1"],ik.eight=$(ik.arrayOfOnes),ik.e2f={K:"K",Q:"D",R:"T",B:"L",N:"S",P:"p"},ik.f2e={k:"k",d:"q",t:"r",l:"b",s:"n",p:"p"},ik.boobs=/^\[(.)(.+)\]/;var a=["wk","wq","wr","wb","wn","wp","bk","bq","br","bb","bn","bp","xwk","xwq","xwr","xwb","xwn","xwp","xbk","xbq","xbr","xbb","xbn","xbp"],b={};ik.imgPieces={},$.each(a,function(a,c){b[c]=ik.fig_path+c+".gif",ik.imgPieces[c]=$("<img>").attr("src",b[c])})}function c(){var a=$("#diagram_position").val().trim();a=a.replace(/\d+/g,function(a){return"1".times(Number(a))}).replace(/\/(?=\/)/g,"/8").replace(/[^\/]+/g,function(a){return a.pad("1",8)}),_.each(a.split("/"),function(a,b){ik.board[b]=a.split(/(?!\w*[\)|\]])/)})}function d(){var b,c,d,e,f,g,h,i;a(),$(["#diagram_white","#diagram_black","#white_c","#black_c"]).each(function(a,e){$($(e).val().toLowerCase().split(/\W/)).each(function(e,j){if(j.length<2)return;j.length==2&&(j="p"+j),j=j.toLowerCase(),i=j.match(/(..?)(..)$/),f=i[1],g=i[2].charCodeAt(0),h=i[2].charAt(1);if(g<97||g>104)return;if(h<"1"||h>"8")return;switch(!0){case a>1:b="[x",c="]";break;default:b=c=""}d=a%2==0?function(a){return a.toUpperCase()}:idem,ik.board[8-h][g-97]=b+d(ik.f2e[f]||"("+f+")")+c})})}function e(){var a,b,c,d,e,h,i,j,k,l="";_(ik.board).each(function(a,j){_(a).each(function(a,m){i=$('.pieceOnBoard[data-x="'+j+'"][data-y="'+m+'"]');if(i.data("id")==a)return;if(a=="1")return i.remove();d=a,k=a.match(ik.boobs),k?(a=k[2],l="x"):l="",i.remove(),(k=a.match(/\((.+)\)/))?(c=_(ik.pieces).find(function(a){return a.code==k[1].toUpperCase()}),c=c?o(k[1])+c.glyph1:"magic",b=$("<img>").attr("src",ik.fig_path+c+".gif")):b=ik.imgPieces[l+o(a)+a.toLowerCase()].clone(),$("#divBlank").append(b),h=m*25+1,e=j*25+1,b.css({position:"absolute",top:e+"px",left:h+"px"}).attr("data-x",j).attr("data-y",m).data("id",d).addClass("pieceOnBoard ui-draggable").draggable({revert:!1,zIndex:5,stop:function(a,b){var c=$(this);ik.board[c.data("x")][c.data("y")]="1",g(),f(),c.remove()}})})});var m=ik.board.join("").match(/[a-z]/g),n=ik.board.join("").match(/[A-Z]/g)}function f(){var a;a=_(ik.board).map(function(a){return a.join("")}).join("/").replace(/\d+/g,function(a){return a.length}),$("#diagram_position").val(a)}function g(){var a,b,c,d,e,f={diagram_white:[],diagram_black:[],white_c:[],black_c:[]};_(ik.board).each(function(a,e){_(a).each(function(a,g){b=a.match(ik.boobs),b?(c=!0,a=b[2]):c=!1;var h=function(a){return a.match(/^\(?[A-Z]/)?!0:!1};if(a!=="1"){switch(!0){case!c&&h(a):d="diagram_white";break;case!c&&!h(a):d="diagram_black";break;case c&&h(a):d="white_c";break;case c&&!h(a):d="black_c"}a=a.toUpperCase(),f[d].push((ik.e2f[a]||a.replace(/\(|\)/g,""))+String.fromCharCode(g+97)+(8-e).toString())}})});for(var g in f)$("#"+g).val(f[g].sort(k).join(" "))}function h(){return $("diagram_stipulation").value.length<2?(new Effect.Highlight("diagram_stipulation",{startcolor:"ffffee",transition:Effect.Transitions.linear,duration:2}),new Effect.Pulsate("diagram_stipulation",{duration:2}),$("diagram_stipulation").focus(),!1):!0}function i(a){return a.keyCode<32||a.keyCode>58?!1:(d(),e(),f(),!0)}function j(a){return c(),e(),g(),!0}function k(a,b){var c;if(c=a.match(ik.boobs))a=c[2];if(c=b.match(ik.boobs))b=c[2];var d="KDTLSp";return d.indexOf(a.substr(0,1))-d.indexOf(b.substr(0,1))}function l(){$("#showfairy").hide(),$("#fairy").show()}function m(a){var b=[],c="";$("#twin").val(""),$("#twn").val(toLowerCase().split(/.\)|\.|\,/).each(function(a,d){if(d.length<3)return;switch(!0){case b=d.match(/(\w\w)-?>(\w\w)/),b!=null:c="Move "+b[1]+" "+b[2];break;case b=d.match(/\+(\w)(\w)(\w\w)/),b!=null:c="Add "+(b[1]=="w"?"White ":"Black ")+b[2]+b[3];break;case b=d.match(/\-(\w)(\w)(\w\w)/),b!=null:c="Remove "+(b[1]=="w"?"White ":"Black ")+b[2]+b[3];break;case b=d.match(/\w*(\w\w)<.*>\w*(\w\w)/),b!=null:c="Exchange "+b[1]+" "+b[2];break;default:return}$("#twin").attr("value",$("#twin").attr("value")+("Twin "+c+"\n"))}))}function n(){e(),g(),f()}function o(a){return a<"a"?"w":"b"}"use strict",$("#solving").hide(),b(),$("#change-view").click(function(a){(ik.solving_view=!ik.solving_view)?($("#change-view").button({label:" Change to data entry view "}),$("#catalog").hide(),$("#solving").show()):($("#change-view").button({label:" Change to solving view "}),$("#catalog").show(),$("#solving").hide())}),$("#fen_button").click(function(a){$("#fen-block").toggle(),a.preventDefault()}),$("#fairy_button").click(function(a){$("#fairy-block").toggle(),a.preventDefault()}),$("#solve").click(function(a){var b=$("form");$("#solve").val(" Solving... "),$.post("/diagrams/solve",{stipulation:$("#diagram_stipulation").val(),position:$("#diagram_position").val(),twin:$("#diagram_twin").val(),pyopts:$("#pyopts").val()},function(a){$("#solution").html(a),$("#solve").val("Finished.  Solve again.")}),a.preventDefault()}),$("#authors_ids").tokenInput("/authors/json",{hintText:"Start typing author's name or handle",minChars:3,prePopulate:$.parseJSON($("#authors_json").val()),theme:"facebook",onBeforeAdd:function(a){var b;isNaN(a.id)&&(b=a.id.match(/^CREATE_(.+?)$/))&&(a.name=b[1])}}),$("#diagram_white").bind("keyup",i),$("#diagram_black").bind("keyup",i),$("#diagram_position").bind("keyup",j),$("#white_c").bind("keyup",i),$("#black_c").bind("keyup",i),$("#diagram_position").val()?j():i({keyCode:50}),$("#diagram_white").focus(),$(".todrag").draggable({revertDuration:0,revert:!0,cursor:"crosshair",zIndex:5}),$("#blank").droppable({drop:function(a,b){var c=$("#blank").offset(),d=b.draggable;ik.board[Math.floor((b.offset.top-c.top+12)/25)][Math.floor((b.offset.left-c.left+12)/25)]=d.data("id"),d.hasClass("pieceOnBoard")&&(ik.board[d.data("x")][d.data("y")]="1",d.remove()),n()}}),$(".moveboard").button(),$(".moveboard").click(function(){var a;switch($(this).data("name")){case"▷":$.each(ik.board,function(a,b){b.unshift("1"),b.pop()});break;case"◁":$.each(ik.board,function(a,b){b.shift(),b.push("1")});break;case"△":ik.board.shift(),ik.board.push(ik.arrayOfOnes);break;case"▽":ik.board.pop(),ik.board.unshift(ik.arrayOfOnes);break;case"↺":a=[],ik.eight.each(function(){a.push(ik.arrayOfOnes.slice(0))}),ik.eight.each(function(b,c){ik.eight.each(function(c,d){a[7-c][b]=ik.board[b][c]})}),ik.board=a;break;case"↻":a=[],ik.eight.each(function(){a.push(ik.arrayOfOnes.slice(0))}),ik.eight.each(function(b,c){ik.eight.each(function(c,d){a[c][7-b]=ik.board[b][c]})}),ik.board=a;break;case"↕":ik.board.reverse()}return n(),!1})})