//--------------------------------------
// Expects input fields with IDs "diagram_white" and "diagram_black" with English notation
// Depends upon jQuery
//
// Iļja Ketris (c) 2008-2011
//
google.setOnLoadCallback(function(){function b(){ik.fenish={k:"k",d:"q",t:"r",l:"b",s:"n",p:"p",1:"1"},ik.solving_view=!1,ik.board=[],ik.form=$("form.simple_form"),ik.tree=ik.form.toJSON(),ik.onex8="11111111",ik.blankTr=$("tr[data-id=NEW]").clone(!0),ik.boobs=/^\[(.)(.+)\]/}function c(a){var b={K:"K",Q:"D",R:"T",B:"L",N:"S",P:"p"}[a.toUpperCase()];return b?b.toLowerCase():undefined}function d(){ik.board=[[],[],[],[],[],[],[],[]];var a=$("#diagram_position").val().trim(),b,d;a=a.replace(/\d+/g,function(a){return"1".times(Number(a))}).replace(/\/(?=\/)/g,"/8").replace(/[^\/]+/g,function(a){return a.pad("1",8)}),_.each(a.split("/"),function(a,b){_.each(a.split(""),function(a,d){var e=c(a);if(!e)return;ik.board[b][d]={k:"a",c:a<"a"?"w":"b",p:c(a).toUpperCase(),u:Math.random()}})})}function e(){ik.tree=ik.form.toJSON()}function f(){var a,b,c,d,e,f,i,j;_(ik.board).each(function(a,k){_.each(_.range(8),function(l,m){f=$('.pieceOnBoard[data-x="'+k+'"][data-y="'+m+'"]'),l=a[m];if(!l)return f.remove();if(f.data("u")==l["u"]&&l.u)return;j=l.k&&l.k!="a"?"x":"",i=l.c,f.remove(),c=_(ik.pieces).find(function(a){return a.code==l.p.toUpperCase()}),c=c?c.glyph1:q(l.p),c=j+i+c,b=$("<p>"),b.addClass("sprite-"+c),e=m*25+1,d=k*25+1,b.css({position:"absolute",top:d+"px",left:e+"px"}).attr("data-x",k).attr("data-y",m).data("id",l.p).data("kind",l.k).data("color",l.c).data("u",l.u||Math.random()).addClass("pieceOnBoard").draggable({revert:!1,zIndex:5,stop:function(a,b){var c=$(this);ik.board[c.data("x")][c.data("y")]=undefined,h(),g(),c.remove()}}),$("#divBlank").append(b)})});var k=ik.board.join("").match(/[a-z]/g),l=ik.board.join("").match(/[A-Z]/g)}function g(){var a=!1,b,c=_(ik.board).map(function(c){var d=ik.onex8;return _(c).each(function(c,e){if(c){b=r(c),a=a||c.k!="a"||c.c=="n"||c.p.length!=1||!b;if(a)return;d=d.replaceAt(e,b)}}),d}).join("/").replace(/\d+/g,function(a){return a.length});$("#diagram_position").val(a?"":c)}function h(){var a={},b;_(ik.board).each(function(c,d){_(c).each(function(c,e){if(!c)return;b=c.k+"_"+c.c,c=c.p,a[b]=a[b]?a[b]:[],a[b].push(c.pawnDown()+String.fromCharCode(e+97)+(8-d).toString())})}),_.each(a,function(a,b){$("#diagram_pieces_"+b).val(a.sort(l).join(" "))});return}function i(){return $("diagram_stipulation").value.length<2?(new Effect.Highlight("diagram_stipulation",{startcolor:"ffffee",transition:Effect.Transitions.linear,duration:2}),new Effect.Pulsate("diagram_stipulation",{duration:2}),$("diagram_stipulation").focus(),!1):!0}function j(a){if(a.keyCode>32&&a.keyCode<91||a.keyCode==8||a.type=="focusout")e(),p(),f(),g();return a.type=="focusout"&&h(),!0}function k(a){return a.keyCode>45&&a.keyCode<91||a.keyCode==8?(d(),f(),h(),!0):!1}function l(a,b){var c;if(c=a.match(ik.boobs))a=c[2];if(c=b.match(ik.boobs))b=c[2];var d="KDTLSp";return d.indexOf(a.substr(0,1))-d.indexOf(b.substr(0,1))}function m(a){var b=[],c="";$("#twin").val(""),$("#twn").val(toLowerCase().split(/.\)|\.|\,/).each(function(a,d){if(d.length<3)return;switch(!0){case b=d.match(/(\w\w)-?>(\w\w)/),b!=null:c="Move "+b[1]+" "+b[2];break;case b=d.match(/\+(\w)(\w)(\w\w)/),b!=null:c="Add "+(b[1]=="w"?"White ":"Black ")+b[2]+b[3];break;case b=d.match(/\-(\w)(\w)(\w\w)/),b!=null:c="Remove "+(b[1]=="w"?"White ":"Black ")+b[2]+b[3];break;case b=d.match(/\w*(\w\w)<.*>\w*(\w\w)/),b!=null:c="Exchange "+b[1]+" "+b[2];break;default:return}$("#twin").attr("value",$("#twin").attr("value")+("Twin "+c+"\n"))}))}function n(){f(),h(),g()}function o(a){return a?a<"a"?"w":"b":undefined}function p(){var a,b,c;ik.board=[[],[],[],[],[],[],[],[]],_(ik.tree.diagram.pieces).each(function(d,e){_(d).each(function(d,f){_(d.split(" ")).each(function(d){d=d.toLowerCase(),a=d.match(/^(..?)(..)$/);if(!a)return"";b=a[2].charCodeAt(0),c=a[2].charAt(1);if(isNaN(c)||c-0>8||c-0<1)return"";if(b>122||b<97)return"";ik.board[8-c][b-97]={k:e,c:f,p:a[1].toUpperCase(),u:Math.random()}})})})}function q(a){var b=ik.fenish[a.toLowerCase()];return b||"magic"}function r(a){if(!a)return;var b=ik.fenish[a.p.toLowerCase()];if(!b)return;return a.c.toLowerCase()==="w"?b.toUpperCase():b.toLowerCase()}"use strict",$("#solving").hide(),b(),p(),n(),$("#squared select").live("change",function(a){var b=$(this),c=b.find("option:selected").val();_(b.parent().next().next().children()).each(function(a){$(a).attr("disabled",c==""),$(a).attr("name","diagram[pieces]["+c+"]["+$(a).data("color")+"]").attr("id","diagram_pieces_"+c+"_"+$(a).data("color"))}),$('#squared option[value=""]:selected').length||ik.blankTr.clone(!0).appendTo($("#squared")).find("select").removeAttr("disabled")}),$("#change-view").click(function(a){(ik.solving_view=!ik.solving_view)?($("#change-view").button({label:" Change to data entry view "}),$("#catalog").hide(),$("#solving").show()):($("#change-view").button({label:" Change to solving view "}),$("#catalog").show(),$("#solving").hide())}),$("#fen_button").click(function(a){$("#fen-block").toggle(),a.preventDefault()}),$("#fairy_button").click(function(a){$("#fairy-block").toggle(),a.preventDefault()});var a=function(a){var b=$("form");a&&$("#solve").val(" Solving... "),$.post("/diagrams/solve",{stipulation:$("#diagram_stipulation").val(),position:$("#diagram_position").val(),pieces:b.toJSON().diagram.pieces,twin:$("#diagram_twin").val(),pyopts:$("#pyopts").val(),conds:$("#diagram_fairy").val(),solve:a},function(b){$("#solution").html(b),a&&$("#solve").val("Finished.  Solve again.")})};$("#solve").click(function(b){a(!0),b.preventDefault()}),$("#showpopeye").click(function(b){a(!1),b.preventDefault()}),$("#authors_ids").tokenInput("/authors/json",{hintText:"Start typing author's name or handle",minChars:3,prePopulate:$.parseJSON($("#authors_json").val()),theme:"facebook",onBeforeAdd:function(a){var b;isNaN(a.id)&&(b=a.id.match(/^CREATE_(.+?)$/))&&(a.name=b[1])}}),$("#pieceinputs input[type=text]:not(#diagram_position)").live("keyup blur",j),$("#diagram_position").bind("keyup",k),$("#diagram_white").focus(),$(".todrag").draggable({revertDuration:0,revert:!0,cursor:"crosshair",zIndex:5}),$("#blank").droppable({drop:function(a,b){var c=$("#blank").offset(),d=b.draggable;ik.board[Math.floor((b.offset.top-c.top+12)/25)][Math.floor((b.offset.left-c.left+12)/25)]={p:d.data("id"),k:d.data("kind"),c:d.data("color"),u:d.data("u")||Math.random()},d.hasClass("pieceOnBoard")&&(ik.board[d.data("x")][d.data("y")]=undefined,d.remove()),n()}}),$(".moveboard").button(),$(".moveboard").click(function(){var a,b;a=[[],[],[],[],[],[],[],[]];switch($(this).text()){case"▷":_.each(ik.board,function(a){a.unshift(undefined),a.length>8&&a.pop()});break;case"◁":_.each(ik.board,function(a){a.shift(),a.push(undefined)});break;case"△":ik.board.shift(),ik.board.push([]);break;case"▽":ik.board.pop(),ik.board.unshift([]);break;case"↺":b=function(b,c,d){a[7-c][b]=d};case"↻":b=b||function(b,c,d){a[c][7-b]=d},_(ik.board).each(function(a,c){_(a).each(function(a,d){b(c,d,a)})}),ik.board=a;break;case"↕":ik.board.reverse()}return n(),!1})});