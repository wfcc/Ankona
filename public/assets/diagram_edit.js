//--------------------------------------
// Expects input fields with IDs "diagram_white" and "diagram_black" with English notation
// Depends upon jQuery
//
// Iļja Ketris (c) 2008-2011
//
google.setOnLoadCallback(function(){function a(){for(var a=0;a<8;++a)ik.board[a]=ik.arrayOfOnes.slice(0)}function b(){ik.board=[],ik.arrayOfOnes=["1","1","1","1","1","1","1","1"],ik.eight=$(ik.arrayOfOnes),ik.notationFullEnglish="KQRBSPkqrbsp",ik.notationFullFIDE="KDTLSpKDTLSp",ik.notationSmallEnglish="kqrbsp",ik.notationSmallFIDE="kdtlsp",ik.boobs=/^\[(.)(.+)\]/;var a=["wk","wq","wr","wb","ws","wp","bk","bq","br","bb","bs","bp","xwk","xwq","xwr","xwb","xws","xwp","xbk","xbq","xbr","xbb","xbs","xbp"],b={};ik.imgPieces={},$.each(a,function(a,c){b[c]=$.globals.fig_path+c+".gif",ik.imgPieces[c]=$("<img>").attr("src",b[c])})}function c(){var a=0,b=0,c,d="",e=[],f=$("#diagram_position").val();f=f.replace(/\d+/g,function(a){return"1".times(Number(a))}),$.each(f.split(""),function(c,f){switch(f){case"[":d="[",a=1;break;case"(":b=2,d="(";break;case"]":e.push(d+"]"),d="",a=b=0;break;case")":d+=")",b=0;break;case"/":e=e.concat("1".times((8-e.length%8)%8).split(""));break;default:switch(a+b){case 0:d.length&&(e.push(d),d=""),e.push(f.n2s());break;default:d+=f}}}),ik.eight.each(function(a,b){c=e.slice(a*8,a*8+8),ik.board[a]=c})}function d(){var b,c,d,e,f,g,h;a(),$(["#diagram_white","#diagram_black","#white_c","#black_c"]).each(function(a,e){$($(e).val().toLowerCase().split(/\W/)).each(function(e,i){i.length==2&&(i="p"+i);if(i.length!=3)return;i=i.toLowerCase(),f=i.charAt(0),g=i.charCodeAt(1),h=i.charAt(2);if(g<97||g>104)return;if(h<"1"||h>"8")return;if("kdtlsp".indexOf(f)<0)return;switch(!0){case a>1:b="[x",c="]";break;default:b=c=""}d=a%2==0?function(a){return a.toUpperCase()}:idem,ik.board[8-h][g-97]=b+d(ik.notationSmallEnglish.charAt(ik.notationSmallFIDE.indexOf(f)))+c})})}function e(){var a,b,c=[],d,e,h,i,j,k="";for(var l=0;l<8;++l)for(var m=0;m<8;++m){a=ik.board[l][m];if(a=="1"){$('.pieceOnBoard[data-x="'+l+'"][data-y="'+m+'"]').remove();continue}j=a.match(ik.boobs),j?(a=j[2],k="x"):k="",i=a>"a"?"b":"w",e=m*25+1,d=l*25+1,a=a.n2s(),h=$('.pieceOnBoard[data-x="'+l+'"][data-y="'+m+'"]');if(h.data("id")==a)continue;h.remove(),b=ik.imgPieces[k+i+a.toLowerCase()].clone(),$("#divBlank").append(b),b.css({position:"absolute",top:d+"px",left:e+"px"}).attr("data-x",l).attr("data-y",m).data("id",a).addClass("pieceOnBoard ui-draggable").draggable({revert:!1,zIndex:5,stop:function(a,b){var c=$(this);ik.board[c.data("x")][c.data("y")]="1",g(),f(),c.remove()}})}var n=ik.board.join("").match(/[a-z]/g),o=ik.board.join("").match(/[A-Z]/g);$("#pcount").html("("+(o?o.length:"0")+" + "+(n?n.length:"0")+")")}function f(){$("#diagram_position").val(ik.board.join("/").replace(/,/g,"").replace(/s/g,"n").replace(/S/g,"N").replace(/\d+/g,function(a){return a.length}))}function g(){var a,b,c,d,e={diagram_white:[],diagram_black:[],white_c:[],black_c:[]};for(var f=0;f<8;++f)for(var g=0;g<8;++g){a=ik.board[f][g],b=a.match(ik.boobs),b?(c=!0,a=b[2]):c=!1;if(a!=="1"){switch(!0){case!c&&a.isWhite():d="diagram_white";break;case!c&&!a.isWhite():d="diagram_black";break;case c&&a.isWhite():d="white_c";break;case c&&!a.isWhite():d="black_c"}e[d].push(ik.notationFullFIDE.substr(ik.notationFullEnglish.indexOf(a),1)+String.fromCharCode(g+97)+(8-f).toString())}}for(var h in e)$("#"+h).val(e[h].sort(k).join(" "))}function h(){return $("diagram_stipulation").value.length<2?(new Effect.Highlight("diagram_stipulation",{startcolor:"ffffee",transition:Effect.Transitions.linear,duration:2}),new Effect.Pulsate("diagram_stipulation",{duration:2}),$("diagram_stipulation").focus(),!1):!0}function i(a){return a.keyCode<32||a.keyCode>58?!1:(d(),e(),f(),!0)}function j(a){return c(),e(),g(),!0}function k(a,b){var c;if(c=a.match(ik.boobs))a=c[2];if(c=b.match(ik.boobs))b=c[2];var d="KDTLSp";return d.indexOf(a.substr(0,1))-d.indexOf(b.substr(0,1))}function l(){$("#showfairy").hide(),$("#fairy").show()}function m(a){var b=[],c="";$("#twin").val(""),$("#twn").val(toLowerCase().split(/.\)|\.|\,/).each(function(a,d){if(d.length<3)return;switch(!0){case b=d.match(/(\w\w)-?>(\w\w)/),b!=null:c="Move "+b[1]+" "+b[2];break;case b=d.match(/\+(\w)(\w)(\w\w)/),b!=null:c="Add "+(b[1]=="w"?"White ":"Black ")+b[2]+b[3];break;case b=d.match(/\-(\w)(\w)(\w\w)/),b!=null:c="Remove "+(b[1]=="w"?"White ":"Black ")+b[2]+b[3];break;case b=d.match(/\w*(\w\w)<.*>\w*(\w\w)/),b!=null:c="Exchange "+b[1]+" "+b[2];break;default:return}$("#twin").attr("value",$("#twin").attr("value")+("Twin "+c+"\n"))}))}function n(){e(),g(),f()}"use strict",b(),$("#fen_button").click(function(a){$("#fen-block").toggle(),a.preventDefault()}),$("#fairy_button").click(function(a){$("#fairy-block").toggle(),a.preventDefault()}),$("#solve").click(function(a){var b=$("form");$("#solve").val(" Solving... "),$.post("/diagrams/solve",{stipulation:$("#diagram_stipulation").val(),position:$("#diagram_position").val()},function(a){$("#solution").html(a),$("#solve").val("Finished.  Solve again.")}),a.preventDefault()}),$("#authors_ids").tokenInput("/authors/json",{hintText:"Start typing author's name or handle",minChars:3,prePopulate:$.parseJSON($("#authors_json").val()),theme:"facebook",onBeforeAdd:function(a){var b;isNaN(a.id)&&(b=a.id.match(/^CREATE_(.+?)$/))&&(a.name=b[1])}}),$("#diagram_white").bind("keyup",i),$("#diagram_black").bind("keyup",i),$("#diagram_position").bind("keyup",j),$("#white_c").bind("keyup",i),$("#black_c").bind("keyup",i),$("#diagram_position").val()?j():i({keyCode:50}),$("#diagram_white").focus(),$(".todrag").draggable({revertDuration:0,revert:!0,cursor:"crosshair",zIndex:5}),$("#blank").droppable({drop:function(a,b){var c=$("#blank").offset(),d=b.draggable;ik.board[Math.floor((b.offset.top-c.top+12)/25)][Math.floor((b.offset.left-c.left+12)/25)]=d.data("id"),d.hasClass("pieceOnBoard")&&(ik.board[d.data("x")][d.data("y")]="1",d.remove()),n()}}),$(".moveboard").button(),$(".moveboard").click(function(){var a;switch($(this).data("name")){case"▷":$.each(ik.board,function(a,b){b.unshift("1"),b.pop()});break;case"◁":$.each(ik.board,function(a,b){b.shift(),b.push("1")});break;case"△":ik.board.shift(),ik.board.push(ik.arrayOfOnes);break;case"▽":ik.board.pop(),ik.board.unshift(ik.arrayOfOnes);break;case"↺":a=[],ik.eight.each(function(){a.push(ik.arrayOfOnes.slice(0))}),ik.eight.each(function(b,c){ik.eight.each(function(c,d){a[7-c][b]=ik.board[b][c]})}),ik.board=a;break;case"↻":a=[],ik.eight.each(function(){a.push(ik.arrayOfOnes.slice(0))}),ik.eight.each(function(b,c){ik.eight.each(function(c,d){a[c][7-b]=ik.board[b][c]})}),ik.board=a;break;case"↕":ik.board.reverse()}return n(),!1})})